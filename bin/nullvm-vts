#!/bin/bash

export PATH
export HOME=$(cd ~; pwd)

BASE=$(cd $(dirname $0)/..; pwd -P)
NULLVMCJAR=$(ls $BASE/nullvmc/target/nullvm-compiler-*one-jar.jar 2> /dev/null)
TARGET=/tmp/nullvm-vts #$(mktemp -d)

mkdir -p $HOME/.nullvm/vts/

#echo "" | gcc -c -E -v -

n=0
while [ ${1:0:1} = '-' ]; do
  if [ "$1" = '-cp' ]; then
    shift
    parts=$(echo $1 | tr ':' '\n')
    for p in $parts; do
      if [ -d "$p" ]; then
        JAR=$HOME/.nullvm/vts/vts$n.jar
        if [ ! -f "$JAR" ]; then
          jar cf $JAR -C "$p" .
        fi
        CP=$(test "x$CP" = "x" && echo "$JAR" || echo "$CP:$JAR")
        n=$((n + 1))
      elif [ -f "$p" ]; then
        CP=$(test "x$CP" = "x" && echo "$p" || echo "$CP:$p")
      fi
    done
  fi
  shift
done

MAINCLASS=$1
shift

while [ "x$1" != 'x' ]; do
  RUNARGS="$RUNARGS $1"
  shift
done

#echo "ARGS=$ARGS"
#echo "RUNARGS=$RUNARGS"
#echo "MAINCLASS=$MAINCLASS"

if [ ! -x $TARGET/vts ]; then
  java -XX:+HeapDumpOnOutOfMemoryError -Xmx1024m -jar $NULLVMCJAR -d $TARGET -o vts -cp $CP
fi

LD_LIBRARY_PATH=$TARGET $TARGET/vts -nvm:MainClass=$MAINCLASS $RUNARGS
CODE=$?
exit $CODE

exit

java -XX:+HeapDumpOnOutOfMemoryError -Xmx1024m -jar $NULLVMCJAR -run -d $TARGET $ARGS
CODE=$?
#rm -rf $TARGET
exit $CODE

